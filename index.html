<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tagshop AI & Product Search</title>
<link rel="stylesheet" href="uniform-dark-glass.css">
<style>
  :root { --glass: rgba(0,0,0,0.35); --stroke: rgba(255,255,255,0.12); --text:#fff; --muted:#cfcfcf; --accent:#ffe169; }
  body { font-family: system-ui; background:#000; color:#fff; padding:20px; transition: background 0.3s, color 0.3s;}
  body.light { background:#f0f0f0; color:#000; }
  h1 { text-align:center; margin-bottom:20px; }
  button { cursor:pointer; border:none; border-radius:6px; padding:8px 12px; font-weight:700; background:#000; color:#fff; margin-top:6px; font-size:12px; }
  .card { background: var(--glass); border:1px solid var(--stroke); border-radius:12px; padding:12px; margin-bottom:20px; }
  .output, #search-results, #aiai-out { background: rgba(255,255,255,0.04); border:1px solid var(--stroke); border-radius:10px; padding:10px; max-height:300px; overflow-y:auto; margin-top:10px; white-space:pre-wrap; }
  .hint { font-size:12px; color:var(--muted); margin-top:6px; }
  .grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(120px,1fr)); gap:12px; }
  .product { border:1px solid var(--stroke); border-radius:8px; padding:6px; text-align:center; background:rgba(0,0,0,0.25); cursor:pointer; }
  .product img { max-width:100%; border-radius:6px; transition: transform 0.2s; }
  .product.expanded img { transform: scale(2); z-index:2; position:relative; }
  input, select, textarea { width:100%; padding:8px; border-radius:6px; border:1px solid var(--stroke); background: rgba(255,255,255,0.06); color: var(--text); margin-top:6px; }
  .product-btns { display:flex; justify-content:center; gap:4px; margin-top:4px; }
  .product-btns button { padding:4px 6px; border-radius:12px; font-size:11px; background:#000; color:#fff; }
</style>
</head>
<body>

<h1>Tagshop</h1>
<button id="toggle-theme">Toggle Light/Dark</button>

<!-- SEARCH CARD -->
<div class="card">
  <h2>Product Search</h2>
  <div class="hint">Search products using Google Custom Search.</div>
  <input type="text" id="search-query" placeholder="Search products..." />
  <button id="search-run">Search</button>
  <button id="toggle-search">Collapse/Expand Results</button>
  <div class="output" id="search-results"></div>
</div>

<!-- AI CHAT CARD -->
<div class="card">
  <h2>AI Chat / Q&A</h2>
  <div class="hint">Ask anything. Choose a model.</div>
  <select id="chat-model">
    <option value="gpt-4.1-nano" selected>GPT-4.1-nano</option>
    <option value="gpt-4.1">GPT-4.1</option>
    <option value="gpt-4o">GPT-4o</option>
    <option value="gpt-5-mini">GPT-5-mini</option>
    <option value="o3-mini">o3-mini</option>
  </select>
  <textarea id="chat-prompt" placeholder="Ask a question..."></textarea>
  <button id="chat-run">Run</button>
  <div class="output" id="chat-out"></div>
</div>

<!-- AIAI CHAT CARD -->
<div class="card">
  <h2>AIAI Streaming Chat</h2>
  <textarea id="aiai-prompt" placeholder="Ask Kimi K2..."></textarea>
  <button id="aiai-run">Run</button>
  <div class="output" id="aiai-out"></div>
</div>

<!-- CONSOLE LOGS -->
<div class="card">
  <h2>Console Logs üñ•Ô∏è</h2>
  <button id="toggle-log">Toggle Logs</button>
  <div class="output" id="console-log" style="display:none;"></div>
</div>

<script src="https://js.puter.com/v2/"></script>
<script>
/* ---------- KEYS ---------- */
const API_KEY = "AIzaSyB9YwW8EVXQJsVwSMbJrk-NU9B9ZrzzkGs"; 
const CSE_ID = "f7e219616fe1d4629"; 

/* ---------- LOG HELPER ---------- */
function log(msg){ 
  console.log(msg); 
  const logEl = document.getElementById("console-log"); 
  logEl.innerHTML += `[${new Date().toLocaleTimeString()}] ${msg}<br>`; 
}

/* ---------- LIGHT/DARK TOGGLE ---------- */
document.getElementById("toggle-theme").addEventListener("click", ()=>{
  document.body.classList.toggle("light");
  log("Toggled light/dark mode.");
});

/* ---------- PRODUCT SEARCH ---------- */
const searchResults = document.getElementById("search-results");
document.getElementById("search-run").addEventListener("click", async ()=>{
  const query = document.getElementById("search-query").value.trim();
  if(!query){ searchResults.innerHTML="Enter a search term."; return; }
  searchResults.innerHTML="Searching...";
  log(`Searching: ${query}`);

  try{
    const res = await fetch(`https://www.googleapis.com/customsearch/v1?key=${API_KEY}&cx=${CSE_ID}&q=${encodeURIComponent(query)}`);
    const data = await res.json();
    searchResults.innerHTML="";
    const grid = document.createElement("div");
    grid.className="grid";
    if(data.items?.length){
      data.items.forEach(item=>{
        const thumb = item.pagemap?.cse_image?.[0]?.src || 'https://via.placeholder.com/100';
        const div = document.createElement("div");
        div.className="product";
        div.innerHTML = `
          <img src="${thumb}" onclick="window.open('${item.link}','_blank')" />
          <div style="font-size:12px; margin-top:4px;">${item.title}</div>
          <div class="product-btns">
            <button onclick="addToWall('${item.title}','${thumb}','${item.link}')">Add to Wall</button>
            <button onclick="viewWall()">View Wall</button>
          </div>
        `;
        grid.appendChild(div);
      });
      searchResults.appendChild(grid);
      log(`Found ${data.items.length} results.`);
    }else{
      searchResults.innerHTML="No results found.";
      log("No results found.");
    }
  }catch(e){
    searchResults.innerHTML="Search error.";
    log("Search error: "+e.message);
  }
});

document.getElementById("toggle-search").addEventListener("click", ()=>{
  searchResults.style.display = searchResults.style.display==="none"?"block":"none";
});

/* ---------- WALL HANDLING ---------- */
function addToWall(title, thumb, link){
  const wall = JSON.parse(localStorage.getItem("productWall")||"[]");
  wall.push({title, thumb, link});
  localStorage.setItem("productWall", JSON.stringify(wall));
  log(`Added to wall: ${title}`);
}

function viewWall(){
  window.location.href = "mywall.html";
}

/* ---------- AI CHAT ---------- */
function putText(el, text){ el.innerHTML = text ?? ''; }
function appendText(el, text){ el.innerHTML += text ?? ''; }

function normalizeNonStream(resp){
  if (!resp) return "";
  if (typeof resp === "string") return resp;
  if (resp.output_text) return resp.output_text;
  if (resp.text) return resp.text;
  if (resp.message?.content) return resp.message.content;
  if (Array.isArray(resp) && resp[0]?.message?.content) return resp[0].message.content;
  return "";
}

document.getElementById("chat-run").addEventListener("click", async ()=>{
  const model = document.getElementById("chat-model").value;
  const prompt = document.getElementById("chat-prompt").value.trim();
  const out = document.getElementById("chat-out");
  if(!prompt){ putText(out,"Enter prompt."); return; }
  putText(out,"Thinking...");
  log(`PromptRun: ${prompt}`);
  try{
    const resp = await puter.ai.chat(prompt, { model });
    putText(out, normalizeNonStream(resp));
    log("AI response received.");
  }catch(e){
    putText(out,"Error: "+(e?.message??e));
    log("AI error: "+(e?.message??e));
  }
});

/* ---------- AIAI CHAT ---------- */
document.getElementById("aiai-run").addEventListener("click", async ()=>{
  const prompt = document.getElementById("aiai-prompt").value.trim();
  const out = document.getElementById("aiai-out");
  if(!prompt){ out.innerHTML="Enter prompt."; return; }
  out.innerHTML="";
  log(`AIAI PromptRun: ${prompt}`);
  try{
    const response = await puter.ai.chat(prompt, { model: 'moonshotai/kimi-k2:free', stream:true });
    for await(const part of response){
      if(part?.text){ out.innerHTML += part.text; }
    }
    log("AIAI response received.");
  }catch(e){
    out.innerHTML="Error: "+(e?.message??e);
    log("AIAI error: "+(e?.message??e));
  }
});

/* ---------- TOGGLE LOGS ---------- */
document.getElementById("toggle-log").addEventListener("click", ()=>{
  const el = document.getElementById("console-log");
  el.style.display = el.style.display==="none"?"block":"none";
});
</script>
</body>
</html>
